name: Build Windows Only

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æ„å»ºç±»å‹'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug
      bundle_types:
        description: 'å®‰è£…åŒ…ç±»å‹'
        required: true
        default: 'msi,nsis'
        type: choice
        options:
          - msi,nsis
          - msi
          - nsis
          - none
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'src-tauri/**'
      - 'package.json'
      - 'vite.config.ts'
      - 'tsconfig.json'
      - '.github/workflows/build-windows-only.yml'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-windows:
    name: ğŸªŸ Windows æ„å»º
    runs-on: windows-latest
    
    steps:
      - name: ğŸ“‚ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: ğŸ¦€ å®‰è£… Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc
      
      - name: ğŸ“¦ ç¼“å­˜ Rust ä¾èµ–
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          key: windows-rust-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            windows-rust-
      
      - name: ğŸ¥ å®‰è£… Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: ğŸ“¦ ç¼“å­˜ Bun ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun
            node_modules
          key: windows-bun-${{ hashFiles('bun.lockb', 'package.json') }}
          restore-keys: |
            windows-bun-
      
      - name: ğŸ“¥ å®‰è£…å‰ç«¯ä¾èµ–
        run: bun install --frozen-lockfile
      
      - name: ğŸ—ï¸ æ„å»ºå‰ç«¯
        run: bun run build
      
      - name: ğŸªŸ æ„å»º Windows åº”ç”¨
        shell: powershell
        run: |
          $buildType = "${{ inputs.build_type || 'release' }}"
          $bundleTypes = "${{ inputs.bundle_types || 'msi,nsis' }}"
          
          Write-Host "ğŸš€ å¼€å§‹æ„å»º Windows ç‰ˆæœ¬..."
          Write-Host "ğŸ“‹ æ„å»ºç±»å‹: $buildType"
          Write-Host "ğŸ“¦ å®‰è£…åŒ…ç±»å‹: $bundleTypes"
          
          if ($buildType -eq "debug") {
            if ($bundleTypes -eq "none") {
              Write-Host "ğŸ”¨ æ‰§è¡Œè°ƒè¯•æ„å»º (æ— å®‰è£…åŒ…)..."
              bun run tauri build --debug --no-bundle
            } else {
              Write-Host "ğŸ”¨ æ‰§è¡Œè°ƒè¯•æ„å»º..."
              bun run tauri build --debug --bundles $bundleTypes
            }
          } else {
            if ($bundleTypes -eq "none") {
              Write-Host "ğŸ”¨ æ‰§è¡Œå‘å¸ƒæ„å»º (æ— å®‰è£…åŒ…)..."
              bun run tauri build --no-bundle
            } else {
              Write-Host "ğŸ”¨ æ‰§è¡Œå‘å¸ƒæ„å»º..."
              bun run tauri build --bundles $bundleTypes
            }
          }
        env:
          # ç¡®ä¿æ— ç­¾åæ„å»º
          TAURI_SIGNING_PRIVATE_KEY: ""
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ""
      
      - name: ğŸ“ æ•´ç†æ„å»ºäº§ç‰©
        shell: powershell
        run: |
          $buildType = "${{ inputs.build_type || 'release' }}"
          $bundleTypes = "${{ inputs.bundle_types || 'msi,nsis' }}"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          New-Item -ItemType Directory -Force -Path "windows-build"
          
          # ç¡®å®šæ„å»ºç›®å½•
          $buildDir = if ($buildType -eq "debug") { "debug" } else { "release" }
          $basePath = "src-tauri\target\x86_64-pc-windows-msvc\$buildDir"
          
          Write-Host "ğŸ“‚ æŸ¥æ‰¾æ„å»ºäº§ç‰©åœ¨: $basePath"
          
          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          $exePath = "$basePath\opcode.exe"
          if (Test-Path $exePath) {
            Copy-Item $exePath "windows-build\"
            Write-Host "âœ… å·²å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶: opcode.exe"
          } else {
            Write-Host "âš ï¸ æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: $exePath"
          }
          
          # å¤åˆ¶å®‰è£…åŒ…
          if ($bundleTypes -ne "none") {
            # MSI å®‰è£…åŒ…
            if ($bundleTypes -match "msi") {
              $msiPath = "$basePath\bundle\msi\*.msi"
              if (Test-Path $msiPath) {
                Copy-Item $msiPath "windows-build\"
                Write-Host "âœ… å·²å¤åˆ¶ MSI å®‰è£…åŒ…"
                Get-ChildItem "$basePath\bundle\msi\" -Filter "*.msi" | ForEach-Object { 
                  Write-Host "  ğŸ“¦ $($_.Name)"
                }
              } else {
                Write-Host "âš ï¸ æœªæ‰¾åˆ° MSI å®‰è£…åŒ…: $msiPath"
              }
            }
            
            # NSIS å®‰è£…åŒ…
            if ($bundleTypes -match "nsis") {
              $nsisPath = "$basePath\bundle\nsis\*.exe"
              if (Test-Path $nsisPath) {
                Copy-Item $nsisPath "windows-build\"
                Write-Host "âœ… å·²å¤åˆ¶ NSIS å®‰è£…åŒ…"
                Get-ChildItem "$basePath\bundle\nsis\" -Filter "*.exe" | ForEach-Object { 
                  Write-Host "  ğŸ“¦ $($_.Name)"
                }
              } else {
                Write-Host "âš ï¸ æœªæ‰¾åˆ° NSIS å®‰è£…åŒ…: $nsisPath"
              }
            }
          }
          
          # ç”Ÿæˆæ ¡éªŒå’Œ
          if ((Get-ChildItem "windows-build" | Measure-Object).Count -gt 0) {
            Write-Host "ğŸ” ç”Ÿæˆæ ¡éªŒå’Œ..."
            Get-ChildItem "windows-build\*" -File | ForEach-Object {
              $hash = Get-FileHash $_.FullName -Algorithm SHA256
              "$($hash.Hash.ToLower())  $($_.Name)" | Out-File -Append -FilePath "windows-build\checksums.txt" -Encoding UTF8
            }
            Write-Host "âœ… æ ¡éªŒå’Œæ–‡ä»¶å·²ç”Ÿæˆ"
          }
          
          # æ˜¾ç¤ºæœ€ç»ˆç»“æœ
          Write-Host ""
          Write-Host "ğŸ“‹ æ„å»ºå®Œæˆï¼äº§ç‰©åˆ—è¡¨:"
          Get-ChildItem "windows-build" | ForEach-Object {
            $size = if ($_.PSIsContainer) { "æ–‡ä»¶å¤¹" } else { "{0:N2} MB" -f ($_.Length / 1MB) }
            Write-Host "  ğŸ“„ $($_.Name) - $size"
          }
      
      - name: ğŸ“Š æ„å»ºä¿¡æ¯
        shell: powershell
        run: |
          Write-Host "ğŸ—ï¸ æ„å»ºä¿¡æ¯æ‘˜è¦"
          Write-Host "==================="
          Write-Host "ğŸ·ï¸ æ„å»ºç±»å‹: ${{ inputs.build_type || 'release' }}"
          Write-Host "ğŸ“¦ å®‰è£…åŒ…ç±»å‹: ${{ inputs.bundle_types || 'msi,nsis' }}"
          Write-Host "ğŸ–¥ï¸ å¹³å°: Windows x64"
          Write-Host "ğŸ“… æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"
          Write-Host "ğŸ”— æäº¤: ${{ github.sha }}"
          Write-Host "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
          Write-Host ""
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          if (Test-Path "windows-build") {
            $totalSize = (Get-ChildItem "windows-build" -File | Measure-Object Length -Sum).Sum
            Write-Host "ğŸ’¾ æ€»æ–‡ä»¶å¤§å°: {0:N2} MB" -f ($totalSize / 1MB)
          }
      
      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: opcode-windows-${{ inputs.build_type || 'release' }}-${{ github.run_number }}
          path: windows-build/*
          retention-days: 30
          compression-level: 6
      
      - name: ğŸ” ä¸Šä¼ æ„å»ºæ—¥å¿— (å¤±è´¥æ—¶)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-windows-${{ github.run_number }}
          path: |
            src-tauri/target/x86_64-pc-windows-msvc/*/build/*/output
            src-tauri/target/x86_64-pc-windows-msvc/*/build/*/stderr
          retention-days: 7
      
      - name: ğŸ“ æ„å»ºæ€»ç»“
        if: always()
        shell: powershell
        run: |
          if (${{ job.status }} -eq "success") {
            Write-Host "ğŸ‰ Windows æ„å»ºæˆåŠŸå®Œæˆï¼"
            Write-Host ""
            Write-Host "ğŸ“¥ ä¸‹è½½æ–¹å¼:"
            Write-Host "1. è¿›å…¥ GitHub Actions é¡µé¢"
            Write-Host "2. æ‰¾åˆ°å½“å‰å·¥ä½œæµè¿è¡Œ"
            Write-Host "3. åœ¨ 'Artifacts' éƒ¨åˆ†ä¸‹è½½ 'opcode-windows-${{ inputs.build_type || 'release' }}-${{ github.run_number }}'"
            Write-Host ""
            Write-Host "ğŸ“¦ åŒ…å«æ–‡ä»¶:"
            Write-Host "â€¢ opcode.exe - ç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶"
            if ("${{ inputs.bundle_types || 'msi,nsis' }}" -match "msi") {
              Write-Host "â€¢ *.msi - Windows MSI å®‰è£…åŒ…"
            }
            if ("${{ inputs.bundle_types || 'msi,nsis' }}" -match "nsis") {
              Write-Host "â€¢ *.exe - NSIS å®‰è£…ç¨‹åº"
            }
            Write-Host "â€¢ checksums.txt - SHA256 æ ¡éªŒå’Œ"
            Write-Host ""
            Write-Host "âš¡ æç¤º: è¿™æ˜¯æ— ç­¾åç‰ˆæœ¬ï¼Œé€‚ç”¨äºå¼€å‘å’Œæµ‹è¯•!"
          } else {
            Write-Host "âŒ Windows æ„å»ºå¤±è´¥"
            Write-Host "ğŸ“‹ è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯"
            Write-Host "ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥:"
            Write-Host "â€¢ æ£€æŸ¥ Rust å·¥å…·é“¾æ˜¯å¦æ­£ç¡®å®‰è£…"
            Write-Host "â€¢ éªŒè¯å‰ç«¯æ„å»ºæ˜¯å¦æˆåŠŸ"
            Write-Host "â€¢ æŸ¥çœ‹ Tauri é…ç½®æ˜¯å¦æœ‰æ•ˆ"
          }

  # å¿«é€ŸçŠ¶æ€æŠ¥å‘Š
  status:
    name: ğŸ“Š æ„å»ºçŠ¶æ€
    runs-on: ubuntu-latest
    needs: build-windows
    if: always()
    
    steps:
      - name: ğŸ“¢ çŠ¶æ€é€šçŸ¥
        run: |
          if [[ "${{ needs.build-windows.result }}" == "success" ]]; then
            echo "ğŸ‰ âœ… Windows æ„å»ºæˆåŠŸ!"
            echo "ğŸ“¦ å¯ç”¨ä¸‹è½½: opcode-windows-${{ inputs.build_type || 'release' }}-${{ github.run_number }}"
          elif [[ "${{ needs.build-windows.result }}" == "failure" ]]; then
            echo "ğŸ’¥ âŒ Windows æ„å»ºå¤±è´¥"
            echo "ğŸ”§ è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
          elif [[ "${{ needs.build-windows.result }}" == "cancelled" ]]; then
            echo "â¹ï¸ âš ï¸ Windows æ„å»ºè¢«å–æ¶ˆ"
          else
            echo "â“ Windows æ„å»ºçŠ¶æ€æœªçŸ¥: ${{ needs.build-windows.result }}"
          fi
          
          echo ""
          echo "ğŸ”— å·¥ä½œæµè¿è¡Œ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
